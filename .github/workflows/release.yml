name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # Build WordPress Plugin Zip
  # ---------------------------------------------------------------------------
  build-plugin:
    name: Build Plugin ZIP
    runs-on: ubuntu-latest
    outputs:
      zip_name: ${{ steps.zip.outputs.zip_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer

      - name: Install Composer production dependencies
        working-directory: wordpress-plugin
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction

      - name: Determine version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build plugin ZIP
        id: zip
        run: |
          ZIP_NAME="ai-wp-dynamic-cache-${{ steps.version.outputs.version }}.zip"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"

          # Create a clean staging directory
          mkdir -p dist/ai-wp-dynamic-cache

          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='tests' \
            --exclude='phpunit.xml*' \
            --exclude='.phpcs.xml*' \
            --exclude='phpstan.neon*' \
            --exclude='node_modules' \
            --exclude='*.test.*' \
            --exclude='*.spec.*' \
            --exclude='*.md' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            wordpress-plugin/ dist/ai-wp-dynamic-cache/

          cd dist
          zip -r "../${ZIP_NAME}" ai-wp-dynamic-cache/
          cd ..

          echo "Built ${ZIP_NAME}"
          ls -lh "${ZIP_NAME}"

      - name: Upload plugin ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-zip
          path: ${{ steps.zip.outputs.zip_name }}
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Deploy Cloudflare Worker
  # ---------------------------------------------------------------------------
  deploy-worker:
    name: Deploy Cloudflare Worker
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: workers/package-lock.json

      - name: Install dependencies
        working-directory: workers
        run: npm ci

      - name: Build Worker
        working-directory: workers
        run: npm run build

      - name: Deploy with Wrangler
        working-directory: workers
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # ---------------------------------------------------------------------------
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-plugin
      - deploy-worker

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download plugin ZIP artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-zip

      - name: Generate release notes
        id: notes
        run: |
          # Extract changes since the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "${PREV_TAG}" ]]; then
            NOTES=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s" --no-merges)
          else
            NOTES=$(git log --pretty=format:"- %s" --no-merges | head -20)
          fi
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "${NOTES}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "AI WP Dynamic Cache ${{ github.ref_name }}"
          body: |
            ## What's Changed

            ${{ steps.notes.outputs.notes }}

            ## Installation

            1. Download `${{ needs.build-plugin.outputs.zip_name }}` below.
            2. In your WordPress admin go to **Plugins → Add New → Upload Plugin**.
            3. Upload the ZIP and activate the plugin.
            4. Configure the Cloudflare Worker URL and HMAC secret under **Settings → AI WP Cache**.

            ## Cloudflare Worker

            The Worker has been deployed automatically to Cloudflare.
          files: ${{ needs.build-plugin.outputs.zip_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
