# nginx-microcache-snippets.conf
# Nginx FastCGI micro-caching snippets for WordPress.
#
# INSTALLATION
# ------------
# 1. Copy the fastcgi_cache_path directive to the `http {}` block in /etc/nginx/nginx.conf
#    (or to a file included from that block, e.g. /etc/nginx/conf.d/fastcgi-cache.conf).
# 2. Copy the remaining directives into your WordPress server block
#    (typically /etc/nginx/sites-available/wordpress).
# 3. Test and reload: nginx -t && systemctl reload nginx

# ===========================================================================
# 1. Cache path – add to the http {} block in nginx.conf
# ===========================================================================
#
# fastcgi_cache_path /tmp/nginx_cache
#     levels=1:2
#     keys_zone=wp_cache:10m
#     max_size=100m
#     inactive=60m
#     use_temp_path=off;
#
# fastcgi_cache_key "$scheme$request_method$host$request_uri";
#
# ===========================================================================

# ===========================================================================
# 2. Cache bypass conditions – add inside the server {} block
# ===========================================================================
#
# set $skip_cache 0;
#
# # Skip cache for POST requests
# if ($request_method = POST) {
#     set $skip_cache 1;
# }
#
# # Skip cache for URLs with query strings (optional – remove if you want
# # paginated/filtered pages to be cached)
# if ($query_string != "") {
#     set $skip_cache 1;
# }
#
# # Skip cache for logged-in users and recent commenters
# if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
#     set $skip_cache 1;
# }
#
# # Skip cache for WooCommerce cart / checkout / account
# if ($request_uri ~* "/(cart|checkout|my-account)(/|$)") {
#     set $skip_cache 1;
# }
#
# # Skip cache for WooCommerce session cookies
# if ($http_cookie ~* "woocommerce_items_in_cart|woocommerce_cart_hash|wp_woocommerce_session") {
#     set $skip_cache 1;
# }
#
# ===========================================================================

# ===========================================================================
# 3. Cache key – customise inside the http {} block (optional)
# ===========================================================================
#
# By default the key is set globally (see section 1). Override per location:
#
# fastcgi_cache_key "$scheme$request_method$host$request_uri$cookie_PHPSESSID";
#
# For mobile-aware caching, include the user agent bucket:
#
# map $http_user_agent $is_mobile {
#     default          0;
#     "~*(android|iphone|ipod|blackberry|mobile)" 1;
# }
# fastcgi_cache_key "$scheme$request_method$host$request_uri$is_mobile";
#
# ===========================================================================

# ===========================================================================
# 4. FastCGI pass with caching – add inside location ~ \.php$ {}
# ===========================================================================
#
# location ~ \.php$ {
#     try_files $uri =404;
#
#     include        fastcgi_params;
#     fastcgi_pass   php;           # upstream name defined elsewhere
#     fastcgi_index  index.php;
#     fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
#     fastcgi_read_timeout 300;
#
#     # Attach the cache zone
#     fastcgi_cache        wp_cache;
#     fastcgi_cache_valid  200 301 302 1h;
#     fastcgi_cache_valid  404           1m;
#
#     # Bypass / no-store based on the $skip_cache variable
#     fastcgi_cache_bypass $skip_cache;
#     fastcgi_no_cache     $skip_cache;
#
#     # Serve stale on upstream errors / updates
#     fastcgi_cache_use_stale error timeout updating http_500 http_503;
#     fastcgi_cache_lock      on;
#     fastcgi_cache_min_uses  1;
#
#     # Expose cache status in response headers
#     add_header X-Cache-Status $upstream_cache_status;
#     add_header X-Powered-By   "AI WP Dynamic Cache";
# }
#
# ===========================================================================

# ===========================================================================
# 5. Static asset caching – add inside the server {} block
# ===========================================================================
#
# location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
#     expires      1y;
#     add_header   Cache-Control "public, immutable";
#     add_header   X-Powered-By  "AI WP Dynamic Cache";
#     access_log   off;
#     try_files    $uri =404;
# }
#
# ===========================================================================

# ===========================================================================
# 6. Gzip – add to the http {} block in nginx.conf
# ===========================================================================
#
# gzip            on;
# gzip_vary       on;
# gzip_proxied    any;
# gzip_comp_level 6;
# gzip_types      text/plain text/css text/xml application/json
#                 application/javascript application/rss+xml
#                 application/atom+xml image/svg+xml;
#
# ===========================================================================
