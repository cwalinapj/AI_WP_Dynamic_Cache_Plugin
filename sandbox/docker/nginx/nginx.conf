fastcgi_cache_path /tmp/nginx_cache levels=1:2 keys_zone=wp_cache:10m max_size=100m inactive=60m use_temp_path=off;
fastcgi_cache_key "$scheme$request_method$host$request_uri";

upstream php {
    server wordpress:9000;
}

gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml application/json application/javascript
           application/rss+xml application/atom+xml image/svg+xml;

server {
    listen 80;
    server_name _;

    root /var/www/html;
    index index.php index.html;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log warn;

    # ---------------------------------------------------------------------------
    # Cache bypass conditions
    # ---------------------------------------------------------------------------
    set $skip_cache 0;

    # Do not cache POST requests
    if ($request_method = POST) {
        set $skip_cache 1;
    }

    # Do not cache URLs with query strings
    if ($query_string != "") {
        set $skip_cache 1;
    }

    # Do not cache logged-in users or recent commenters
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $skip_cache 1;
    }

    # Bypass cache for WooCommerce cart and checkout
    if ($request_uri ~* "/(cart|checkout|my-account)(/|$)") {
        set $skip_cache 1;
    }

    # Bypass cache for WooCommerce session cookies
    if ($http_cookie ~* "woocommerce_items_in_cart|woocommerce_cart_hash|wp_woocommerce_session") {
        set $skip_cache 1;
    }

    # ---------------------------------------------------------------------------
    # Static assets â€“ long-lived cache headers
    # ---------------------------------------------------------------------------
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Powered-By "AI WP Dynamic Cache";
        access_log off;
        try_files $uri =404;
    }

    # ---------------------------------------------------------------------------
    # Main location
    # ---------------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        try_files $uri =404;

        include fastcgi_params;
        fastcgi_pass   php;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param  PHP_VALUE "upload_max_filesize=64M \n post_max_size=64M";
        fastcgi_read_timeout 300;

        # FastCGI cache
        fastcgi_cache        wp_cache;
        fastcgi_cache_valid  200 301 302 1h;
        fastcgi_cache_valid  404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache     $skip_cache;
        fastcgi_cache_use_stale error timeout updating http_500 http_503;
        fastcgi_cache_lock   on;
        fastcgi_cache_min_uses 1;

        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Powered-By "AI WP Dynamic Cache";
    }

    # Deny access to sensitive files
    location ~ /\.(ht|git) {
        deny all;
    }

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }
}
